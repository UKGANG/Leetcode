'''
1293. Shortest Path in a Grid with Obstacles Elimination
https://leetcode.com/problems/shortest-path-in-a-grid-with-obstacles-elimination/
'''
import collections
import heapq
import itertools
from typing import List

from test_tool import assert_value


class Solution(object):
    def shortestPath(self, grid: List[List[int]], k: int) -> int:
        m, n = len(grid), len(grid[0])
        curr_level = [(0, -k, 0, 0)]
        visited = set([(-k, 0, 0)])
        while curr_level:
            dist, k_rest, x, y = heapq.heappop(curr_level)
            k_rest = -k_rest
            if (x, y) == (m - 1, n - 1):
                return dist
            move = itertools.product([-1, 0, 1], [-1, 0, 1])
            move = [(dx, dy) for dx, dy in move if dx * dy == 0 and dx != dy]
            move = [(x + dx, y + dy) for dx, dy in move]
            move = [(x, y) for x, y in move if 0 <= x < m and 0 <= y < n]
            for i, j in move:
                next_dist, next_k_rest = dist + 1, k_rest - grid[i][j]
                if (-next_k_rest, i, j) in visited:
                    continue
                if next_k_rest < 0:
                    continue
                visited.add((-next_k_rest, i, j))
                heapq.heappush(curr_level, (next_dist, -next_k_rest, i, j))
        return -1

    def _shortestPath(self, grid: List[List[int]], k: int) -> int:
        q = collections.deque()
        visited = set()
        m, n = len(grid), len(grid[0])
        x, y, k, step = 0, 0, k - grid[0][0], 0
        q.append((x, y, k, step))

        while q:
            x, y, k, step = q.popleft()
            if x == m - 1 and y == n - 1:
                return step
            direction = [
                (x + 1, y),
                (x, y + 1),
                (x - 1, y),
                (x, y - 1),
            ]
            for _x, _y in direction:
                if not (0 <= _x < m and 0 <= _y < n):
                    continue
                _k, _step = k - grid[_x][_y], step + 1
                if _k < 0:
                    continue
                if (_x, _y, _k) in visited:
                    continue
                q.append((_x, _y, _k, _step))
                visited.add((_x, _y, _k))

        return -1


assert_value(6, Solution().shortestPath, grid=[[0, 0, 0], [1, 1, 0], [0, 0, 0], [0, 1, 1], [0, 0, 0]], k=1)
assert_value(-1, Solution().shortestPath, grid=[[0, 1, 1], [1, 1, 1], [1, 0, 0]], k=1)
assert_value(14, Solution().shortestPath,
             grid=[
                 [0, 0],
                 [1, 0],
                 [1, 0],
                 [1, 0],
                 [1, 0],
                 [1, 0],
                 [0, 0],
                 [0, 1],
                 [0, 1],
                 [0, 1],
                 [0, 0],
                 [1, 0],
                 [1, 0],
                 [0, 0]
             ]
             , k=4)
assert_value(62, Solution().shortestPath, grid=[
    [0,1,1,1,0,0,0,1,1,0,1,1,1,0,0,1,0,0,1,0,1,0,1,1,0,1,1,0,1,1,1,1,0,0,0,1,1,0,0,1],
    [0,0,0,0,0,1,1,0,0,1,1,0,1,0,1,1,1,0,0,0,0,1,1,1,1,1,0,0,0,1,0,0,1,1,1,0,1,1,1,1],
    [0,1,1,1,1,1,0,1,0,1,0,1,0,1,0,0,1,0,1,1,0,0,1,1,0,0,1,0,1,0,0,1,0,1,1,0,0,0,1,1],
    [0,1,0,1,1,1,1,1,1,0,1,1,0,0,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,0,0,1,0,1,1,0,1,1,1],
    [1,0,0,1,0,1,0,1,0,1,0,1,0,0,0,1,1,1,0,0,0,0,1,0,0,1,0,0,1,1,1,0,1,0,1,1,1,0,0,1],
    [1,1,1,1,1,1,1,0,0,0,0,0,1,0,1,1,0,0,1,0,1,1,1,1,0,0,1,1,1,0,1,0,1,0,1,1,1,0,1,1],
    [0,0,0,1,1,1,0,1,1,1,1,1,0,1,0,0,1,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,0,0,1,1,0,1],
    [0,1,1,0,1,0,0,1,1,1,0,0,1,0,0,1,0,1,1,1,1,1,1,1,0,1,1,0,1,1,1,0,1,0,0,1,0,0,1,0],
    [0,1,0,1,1,0,1,0,0,0,0,1,1,0,0,0,0,1,1,1,1,0,1,0,0,0,0,0,1,1,0,1,1,0,1,1,1,1,1,0],
    [0,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,1,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,0,0],
    [1,0,1,0,0,0,0,0,1,0,0,0,1,1,1,0,1,0,0,0,1,1,0,1,1,1,0,0,1,0,1,1,1,0,0,1,0,0,1,1],
    [0,0,1,1,0,0,1,1,1,0,1,1,0,1,0,0,0,1,1,0,0,0,0,1,1,0,1,1,0,0,1,0,0,1,1,0,0,0,1,0],
    [0,0,0,0,0,0,0,0,0,1,1,0,0,0,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,0,1,0,1,1,1,1,1,0,1,1],
    [0,1,1,1,1,0,0,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,1,0,0,0,1,1,0,1,1,0,1,0,1,0,1,1],
    [1,0,0,0,1,1,1,0,0,0,0,1,1,0,1,1,1,1,1,1,0,0,1,1,1,1,0,0,0,0,1,0,0,0,0,0,1,1,0,1],
    [1,1,1,0,0,0,1,1,1,0,1,1,1,1,1,1,0,0,1,0,0,0,0,1,1,1,1,1,1,1,0,0,0,1,1,1,0,1,0,1],
    [1,0,1,0,1,0,1,1,1,0,1,0,0,0,1,0,0,0,0,1,1,1,0,0,1,1,0,1,1,1,0,1,0,1,0,1,0,1,0,1],
    [0,1,1,0,0,0,1,1,0,0,1,0,1,1,1,0,0,1,0,0,1,1,0,1,0,1,0,1,0,0,0,0,1,0,0,0,0,0,0,1],
    [1,0,1,0,0,1,0,1,0,1,1,1,1,1,0,1,0,0,0,0,0,0,0,1,0,1,0,1,1,1,1,1,0,0,1,0,0,0,1,1],
    [0,1,0,1,0,0,0,1,0,0,1,1,0,0,1,1,0,0,0,1,0,1,1,1,0,1,1,1,0,0,1,1,1,0,0,0,1,0,0,0],
    [0,0,1,0,1,1,1,1,0,0,0,0,0,1,0,1,1,0,1,1,1,1,0,0,0,1,0,1,0,1,0,0,0,0,1,0,1,1,0,1],
    [0,0,1,1,0,1,1,0,1,0,0,0,1,1,0,0,1,1,1,0,0,0,1,0,0,1,0,1,0,0,0,0,0,1,0,1,1,0,0,0],
    [1,1,1,1,0,0,1,0,1,0,1,1,0,1,1,0,0,0,0,1,1,1,1,1,0,1,0,1,0,0,0,0,0,1,0,1,1,1,1,1],
    [0,0,0,0,1,1,0,0,0,1,0,1,1,1,1,1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,0,1,1,1,0,1,0,0,1,0]
], k=617)